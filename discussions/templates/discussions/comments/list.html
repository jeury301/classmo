{% extends 'base.html' %}
{% load static %}

{% csrf_token %}

{% block content %}
    <link href="{% static 'css/comment_list.css' %}" rel="stylesheet" media="screen">

    <div class="discuss-topnav">
        <a href="{% url 'discussions:list_posts' post.subject.id %}">< Back to {{post.subject.name}} forum</a>
    </div>

    {% if not user.is_authenticated %}
    <div>
        <em>
        You need to be logged in to post or comment.  Click <a href="{% url 'login' %}">here to login</a> or <a href="#">create an account</a>.
        </em>
    </div>
    <br/>
    {% endif %}

    {% include "discussions/elements/post_view_controls.html" %}

    {% if comments %}
        <ul class="no-bullets">
        {% for comment in comments %}
            {% if comment.rel_depth > 0 %}
                {% for i in comment.depth_counter %}
                <ul class="no-bullets">
                {% endfor %}
            {% endif %}
            {% if comment.rel_depth < 0 %}
                {% for i in comment.depth_counter %}
                </ul>
                {% endfor %}
            {% endif %}
            <li>
                {% if comment.abs_depth < max_depth %}
                    {% include "discussions/elements/comment_view_controls.html" %}
                {% else %}
                    <div class="discuss-regmargin">
                        <a href="#">See more comments</a>
                    </div>
                {% endif %}
            </li>

        {% endfor %}
        </ul>
    {% else %}
        Looks like there's no comments here yet.
        <a href="{% url 'discussions:new_top' post.id %}">Why not post the first?</a>
    {% endif %}

{% endblock %}

{% block javascript %}
<script>

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                // Only send the token to relative URLs i.e. locally.
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });


    function vote_comment(commentId, val) {
        var scoreSpanId = "comment-score-" + commentId;
        var oldScore = document.getElementById(scoreSpanId).innerHTML

        $.ajax({
            url: "{% url 'discussions:cast_vote' %}",
            type: "POST",
            data: {
                'commentId': commentId,
                'type': 'comment',
                'val': val
            },
            dataType: 'json',
            success: function (data) {
                console.log("Ajax worked");
                console.log(data);

                var upvoteIconId = "comment-upvote-" + commentId
                var novoteIconId = "comment-novote-" + commentId
                var downvoteIconId = "comment-downvote-" + commentId

                /* Highlight the upvote/downvote/no-vote icon as appropriate */
                if (val == 1) {
                    document.getElementById(upvoteIconId).style.color = "DarkOrange";
                } else {
                    document.getElementById(upvoteIconId).style.color = "";
                }

                if (val == 0) {
                    document.getElementById(novoteIconId).style.color = "DarkOrange";
                } else {
                    document.getElementById(novoteIconId).style.color = "";
                }

                if (val == -1) {
                    document.getElementById(downvoteIconId).style.color = "DarkOrange";
                } else {
                    document.getElementById(downvoteIconId).style.color = "";
                }

                /* If the score changed, update and highlight the score */
                if (data.old_score != data.new_score) {
                    document.getElementById(scoreSpanId).style.color = "DarkOrange";
                    document.getElementById(scoreSpanId).innerHTML = data.new_score;
                } else {
                    document.getElementById(scoreSpanId).style.color = "";
                }

            },
            error: function(data) {
                console.log("Ajax failed");
                console.log(data);
            }
        });
    }
</script>
{% endblock %}